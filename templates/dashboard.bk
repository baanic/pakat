
<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ | Ù¾Ø§Ú©Øª</title>
  <link rel="stylesheet" href="/static/css/Style.css">
  <script defer src="/static/js/main.js"></script>
</head>
<body>
  <header>
    <h1>Ù¾Ø§Ú©Øª | Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù‡Ø§</h1>
    <button onclick="toggleTheme()">ØªØºÛŒÛŒØ± ØªÙ…</button>
  </header>

  <div class="pakat-container">
    <!-- ÙÛŒÙ„ØªØ± -->
    <div class="filter-bar">
      <strong>ÙÛŒÙ„ØªØ±:</strong>
      <label><input type="checkbox" onchange="applyFilters()" id="filterIncomplete"> ÙÙ‚Ø· Ø§Ù†Ø¬Ø§Ù…â€ŒÙ†Ø´Ø¯Ù‡</label>
      <label><input type="checkbox" onchange="applyFilters()" id="filterHighPriority"> ÙÙ‚Ø· Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§</label>
      <input type="text" id="filterTag" placeholder="Ø¨Ø±Ú†Ø³Ø¨ (Ù…Ø«Ù„Ø§Ù‹: Ø®Ø±ÛŒØ¯)" oninput="applyFilters()">
    </div>

    <div class="container">
      {% for section_title, section_tasks in [
        ("Ø§Ù…Ø±ÙˆØ²", tasks_today),
        ("ÙØ±Ø¯Ø§", tasks_tomorrow),
        ("Ù‡ÙØªÙ‡ Ø¢ÛŒÙ†Ø¯Ù‡", tasks_week),
        ("Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®", tasks_nodate)
      ] %}
        <h2>{{ section_title }}</h2>
        <div class="task-section" data-section="{{ section_title }}" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
          {% for task in section_tasks %}
            <div class="task-item priority-{{ task.priority }} {% if task.completed %}completed{% endif %}"
                 data-id="{{ task.id }}" draggable="true" ondragstart="handleDrag(event)"
                 data-complete="{{ 'true' if task.completed else 'false' }}" data-priority="{{ task.priority }}" data-tags="{{ ','.join(task.tags or []) }}">
              <form method="POST" action="/toggle-completed/{{ task.id }}">
                <input type="checkbox" onchange="this.form.submit()" {% if task.completed %}checked{% endif %}>
                <span class="task-info">{{ task.text }}</span>
              </form>
              <div class="task-meta">{{ task.jalali_time }}</div>
              {% if task.tags %}
                <div class="task-tags">
                  {% for tag in task.tags %}
                    <span class="tag">#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
{% if task.subtasks %}
  <ul class="subtasks">
    {% for sub in task.subtasks %}
      <li>
        <form method="POST" action="/toggle-subtask/{{ task.id }}/{{ sub.id }}">
          <input type="checkbox" onchange="this.form.submit()" {% if sub.completed %}checked{% endif %}>
          <span class="{% if sub.completed %}completed{% endif %}">{{ sub.text }}</span>
        </form>
      </li>
    {% endfor %}
  </ul>
{% endif %}

<form method="POST" action="/add-subtask/{{ task.id }}">
  <input type="text" name="subtask" placeholder="Ø§ÙØ²ÙˆØ¯Ù† Ø²ÛŒØ±ØªØ³Ú©...">
  <button type="submit">+</button>
</form>

              {% if task.completed %}
                <form method="POST" action="/archive-task/{{ task.id }}">
                  <button type="submit">ğŸ“¦ Ø¢Ø±Ø´ÛŒÙˆ</button>
                </form>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>

  <script>
    let draggedItem = null;

    function allowDrop(e) { e.preventDefault(); }
    function handleDrag(e) { draggedItem = e.target; }
    function handleDrop(e) {
      e.preventDefault();
      const target = e.target.closest(".task-section");
      if (!draggedItem || !target || draggedItem === e.target) return;
      target.appendChild(draggedItem);
      saveOrder();
    }

    function saveOrder() {
      const allItems = document.querySelectorAll(".task-item");
      const order = [...allItems].map(item => parseInt(item.dataset.id));
      fetch("/reorder-tasks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order })
      });
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const mode = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
      localStorage.setItem('theme', mode);
    }

    window.onload = () => {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') document.body.classList.add('dark-mode');
    }

    function applyFilters() {
      const showIncomplete = document.getElementById('filterIncomplete').checked;
      const showHighPriority = document.getElementById('filterHighPriority').checked;
      const tagFilter = document.getElementById('filterTag').value.trim();
      document.querySelectorAll('.task-item').forEach(task => {
        const isDone = task.dataset.complete === 'true';
        const priority = task.dataset.priority;
        const tags = task.dataset.tags.split(',');
        let visible = true;
        if (showIncomplete && isDone) visible = false;
        if (showHighPriority && priority !== 'high') visible = false;
        if (tagFilter && !tags.includes(tagFilter)) visible = false;
        task.style.display = visible ? 'block' : 'none';
      });
    }
  </script>
</body>
</html>
